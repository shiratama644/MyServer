### 1. 外部アクセスとルーティング

-   **基本戦略:** 取得したDDNSホスト名 (`your-host.mydns.jp`) を唯一の入り口とし、NginxがURLのパスに応じて各サイト/サービスにリクエストを振り分ける（パスベースルーティング）。
-   **DDNS自動更新:** `cron`とシェルスクリプトを利用し、10分ごとにMyDNS.jpへグローバルIPアドレスを自動通知する。実行ログはファイルに保存し、`admin`サイトから閲覧可能にする。
-   **ポートフォワーディング:** ルーターにて、外部からの `TCP:80` (HTTP) および `TCP:443` (HTTPS) へのアクセスを、本サーバーのNginxに転送する。
#### 2. ディレクトリ構造

```
/home/your_user/
├── srv/
│   ├── youtube-proxy/
│   │   ├── frontend/   # Next.js
│   │   └── backend/    # Express.js
│   ├── seitokai/       # Next.js (API Routes)
│   ├── 3d-fps/
│   │   ├── frontend/    # Next.js
│   │   ├── web-server/  # Express.js
│   │   └── game-server/ # C++
│   ├── portfolio/      # Next.js (Static Export)
│   ├── discord-chat/
│   │   ├── frontend/   # Next.js
│   │   └── backend/    # Express.js
│   ├── cpu-ranking/    # Next.js (API Routes)
│   ├── admin/
│   │   ├── frontend/   # Next.js
│   │   └── backend/    # Express.js
│   └── discord-bot/    # Node.js
├── scripts/
│   └── update-mydns.sh # DDNS自動更新スクリプト
└── logs/
    └── mydns_update.log  # DDNS自動更新ログ
```

---

### 3. 各サイト仕様

#### 3.1 `youtube-proxy` (YouTubeプロキシ)

-   **URLパス:** `/protube/`
-   **フォルダ:** `srv/youtube-proxy/`
-   **概要:** 本サーバーをプロキシとして、独自のUI/UXでYouTubeを閲覧・利用できるサイト。
-   **構成:** **分離型 (Frontend + Backend)**
-   **フロントエンド:** Next.js
    -   ライブラリ: `React`, `youtubei.js`
    -   機能: YouTubeライクなUI、動画再生、検索、コメント表示
-   **バックエンド:** Express.js
    -   **ポート (PM2):** `3001`
    -   **APIエンドポイント:**
        -   `/api/v1/auth/*`: ユーザー認証（登録、ログイン、ログアウト）
        -   `/api/v1/youtube/*`: YouTube APIへのプロキシリクエスト
        -   `/api/v1/user/*`: お気に入り、閲覧履歴のCRUD
    -   **技術:** `youtubei.js` (サーバーサイド)、`jsonwebtoken` (認証)、`bcryptjs` (パスワードハッシュ化)
-   **データベース:** PostgreSQL
    -   **DB名:** `protube_db`
    -   **ユーザー名:** `protube_user`
    -   **保存データ:** ユーザー情報、ハッシュ化パスワード、お気に入り動画IDリスト、閲覧履歴
-   **ユーザー規模:**
    -   ユーザー数: 約50人
    -   同時接続数: 約5〜10人
-   **NOTE:**
    -   `youtubei.js`の利用はYouTubeの利用規約に抵触する可能性があるため、個人利用の範囲に留めること。
    -   プロキシによるサーバー負荷とネットワーク帯域を監視する必要がある。Redisで検索結果などをキャッシュする戦略が有効。

---

#### 3.2 `seitokai` (中学校生徒会HP)

-   **URLパス:** `/seitokai/`
-   **フォルダ:** `srv/seitokai/`
-   **概要:** 生徒会活動を告知・報告するための公式ホームページ。
-   **構成:** **一体型 (Next.js + API Routes)**
-   **フロントエンド/バックエンド:** Next.js
    -   **ポート (PM2):** `3002`
    -   **API Routes:**
        -   `/api/auth/*`: Googleアカウント認証 (NextAuth.js の利用を推奨)
        -   `/api/posts`: お知らせの投稿・取得 (CRUD)
        -   `/api/comments`: 投稿へのコメント機能
    -   **機能:** 目安箱（一つ500文字制限）、Googleアカウントでのログイン、ページネーション
-   **データベース:** PostgreSQL
    -   **DB名:** `seitokai_db`
    -   **ユーザー名:** `seitokai_user`
    -   **保存データ:** ユーザー情報（Google ID, 名前, メールアドレス）、投稿テキスト、投稿日時、投稿者
-   **ユーザー規模:**
    -   ユーザー数: 約700人
    -   同時接続数: 約10人
-   **NOTE:**
    -   個人情報（特に未成年者の）を扱うため、セキュリティには最大限の注意を払う。SSL化は必須。
    -   NextAuth.jsライブラリを導入するとGoogle認証の実装が大幅に簡略化できる。

---


#### 3.3 `3d-fps` (オンラインFPSゲーム)

-   **URLパス:** `/3d-fps/`
-   **フォルダ:** `srv/3d-fps/`
-   **概要:** Webブラウザでプレイ可能なマルチプレイヤーFPSゲーム (FFA, チームデスマッチ, バトルロイヤル)。
-   **構成:** **ハイブリッド分離型 (Frontend + Web Backend + Game Backend)**
-   **フロントエンド:** Next.js (Client)
    -   **フォルダ:** `srv/3d-fps/frontend/`
    -   **ライブラリ:** `React`, `Babylon.js` (3D描画)
    -   **機能:**
        -   ゲーム画面のレンダリング、アセット読み込み。
        -   Webサーバー(Express.js)へのHTTPリクエスト（ログイン、戦績表示など）。
        -   プレイヤーのキーボード/マウス入力を検知。
        -   ゲームサーバー(C++)とのWebSocket接続を確立し、プレイヤー操作の送信とゲーム状態の受信を行う。

-   **バックエンド:** **2つのサーバーで構成**

    -   **Webサーバー (Node.js)**
        -   **フォルダ:** `srv/3d-fps/web-server/`
        -   **技術:** Express.js
        -   **ポート (PM2):** `3003`
        -   **役割/機能:**
            -   **ユーザー認証:** プレイヤーのログイン/新規登録APIを提供。
            -   **API提供:** 戦績やランキングなど、データベースの情報を取得するAPIエンドポイントを提供。
            -   **マッチメイキング:**
                1.  プレイ待機中のプレイヤーをリスト管理。
                2.  人数が揃ったら、新しいゲームセッションを開始するようゲームサーバー(C++)に通知。
                3.  プレイヤーに対し、接続すべきゲームサーバーのIPアドレスとポート、認証用のセッショントークンを払い出す。

    -   **ゲームサーバー (C++)**
        -   **フォルダ:** `srv/3d-fps/game-server/`
        -   **技術:** C++ (C++17以降を推奨)
        -   **ポート (PM2):** `9001` (Webサーバーとは別ポート)
        -   **ビルド:** `g++` / `clang++` と `Makefile` または `CMake` でビルドした実行可能バイナリをPM2で管理。
        -   **役割/機能:**
            -   **リアルタイム通信:** WebSocket (またはWebRTC/UDP) を利用して、複数のクライアントとの持続的な接続を確立・管理。
                -   *推奨ライブラリ: `uWebSockets`, `websocketpp`, `Boost.Asio`*
            -   **ゲームロジック:** プレイヤーの移動、射撃などのアクションを処理し、当たり判定や物理演算を実行。ゲームのルール（スコア計算、勝敗判定など）を管理。
            -   **状態同期:** 全プレイヤーの最新の状態（位置、向き、HPなど）を、接続されている全クライアントに高速でブロードキャスト（サーバーティックごと）。

-   **データベース:** PostgreSQL
    -   **連携:** 主にWebサーバー(Express.js)がアクセス。ゲームサーバー(C++)も必要に応じて直接アクセス可能。
        -   *C++用推奨ライブラリ: `libpqxx`*
    -   **DB名:** `fpsgames_db`
    -   **ユーザー名:** `fpsgames_user`
    -   **保存データ:** ユーザーアカウント、ハッシュ化パスワード、戦績（キル/デス）、ランキング。

-   **ユーザー規模:**
    -   ユーザー数: 約40人
    -   同時接続数: 約20人 (10 vs 10)

-   **NOTE:**
    -   **責務の分離:** Webサーバーとゲームサーバーを分離することで、各サーバーは自身の役割に特化でき、開発と保守が容易になる。
    -   **低遅延の追求:** ゲームサーバー(C++)は、ガベージコレクションのない言語特性とマルチスレッドを活かし、極限まで低遅延を目指す。
    -   **セキュリティ:** ゲームサーバーに接続する際は、Webサーバーが発行した一時的なセッショントークンで認証を行い、不正な接続を防ぐ。
    -   **PM2管理:** `ecosystem.config.js` にて、Express.jsの起動スクリプトと、C++のコンパイル済みバイナリの両方をプロセスとして登録する。

---
#### 3.4 `portfolio` (ポートフォリオ)

-   **URLパス:** `/` (ルート)
-   **フォルダ:** `srv/portfolio/`
-   **概要:** 自身のスキルや作品を展示するポートフォリオサイト。
-   **構成:** **静的サイト (Next.js Static Export)**
-   **フロントエンド:** Next.js
    -   ライブラリ: `React`, `Three.js` (背景3D)
    -   **ビルド方法:** `next build && next export` で静的HTML/CSS/JSを生成。
-   **バックエンド:** **なし**
    -   Nginxが生成された静的ファイルを直接配信する。
-   **データベース:** なし
-   **ユーザー規模:**
    -   ユーザー数: 約10〜20人
    -   同時接続数: 約1〜2人
-   **NOTE:**
    -   PM2でのプロセス管理は不要。Nginxの設定のみで完結する。

---

#### 3.5 `discord-chat` (Discordチャット連携)

-   **URLパス:** `/dischat/`
-   **フォルダ:** `srv/discord-chat/`
-   **概要:** Discordの特定チャンネルと連携し、Web UI上でチャットができるサイト。
-   **構成:** **分離型 (Frontend + Backend)**
-   **フロントエンド:** Next.js
    -   UI: DiscordライクなUI
    -   機能: メッセージのリアルタイム表示、Webからのメッセージ送信
-   **バックエンド:** Express.js
    -   **ポート (PM2):** `3004`
    -   **通信プロトコル:** **WebSocket** (`Socket.IO`)
    -   **機能:**
        -   `discord-bot` プロセスと内部通信（Redis Pub/Subを使用）
        -   WebクライアントとのWebSocket接続を管理
        -   WebからのメッセージをBotに転送
        -   BotからのメッセージをWebクライアントにブロードキャスト
-   **データベース:** (discord-bot側で管理)
-   **ユーザー規模:**
    -   ユーザー数: (Discordサーバーに依存)
    -   同時接続数: 約1〜5人
-   **TODO:**
    -   `discord-bot` プロセスとこのバックエンド間の連携方法を具体的に設計する（Redis Pub/Sub）。

---

#### 3.6 `cpu-ranking` (CPUランキングサイト)

-   **URLパス:** `/cpuranking/`
-   **フォルダ:** `srv/cpu-ranking/`
-   **概要:** ユーザーがCPUのレビューやスコアを投稿できるランキングサイト。
-   **構成:** **一体型 (Next.js + API Routes)**
-   **フロントエンド/バックエンド:** Next.js
    -   **ポート (PM2):** `3005`
    -   **API Routes:**
        -   `/api/posts`: レビュー投稿（画像アップロード含む）、取得
        -   `/api/ranking`: スコアに基づいたランキングデータ生成
    -   **機能:** テキスト（200文字）、画像（1MBまで）の投稿、ランキング表示
-   **データベース:** PostgreSQL
    -   **DB名:** `cpuranking_db`
    -   **ユーザー名:** `cpuranking_user`
    -   **保存データ:** 投稿テキスト、画像パス、CPUモデル名、スコアなど
-   **ユーザー規模:**
    -   ユーザー数: 約50人
    -   同時接続数: 約1〜5人
-   **NOTE:**
    -   画像アップロード処理では、ファイルサイズチェックや拡張子バリデーションを厳密に行う。
    -   ランキングデータは頻繁に変動しないため、RedisにキャッシュしてDB負荷を軽減するのが効果的。

---

#### 3.7 `admin` (管理者ダッシュボード)

-   **URLパス:** `/admin/`
-   **フォルダ:** `srv/admin/`
-   **概要:** サーバー全体を監視・管理するためのWebベースのダッシュボード。
-   **構成:** **分離型 (Frontend + Backend)**
-   **フロントエンド:** Next.js
    -   UI: ターミナル風UI (`xterm.js`)、グラフ表示 (`Chart.js`)
    -   機能: WebSocket経由でバックエンドからデータを受信し、リアルタイムに表示
-   **バックエンド:** Express.js
    -   **ポート (PM2):** `3006`
    -   **通信プロトコル:** **WebSocket** (`Socket.IO`), REST API
    -   **機能:**
        -   **システム監視:** CPU/RAM/Disk使用率を定期的に取得し、WebSocketで配信 (`systeminformation`)
        -   **PM2連携:** プロセス一覧、起動/停止/再起動 (`pm2` API)
        -   **ログ閲覧:**
            -   Nginx/PM2のログを読み込み、APIで提供。
            -   **MyDNS自動更新ログ (`mydns_update.log`) を読み込み、APIで提供。**
        -   **リモートターミナル:** `node-pty` を利用し、実機のシェルをWebSocket経由で操作可能にする
-   **データベース:** なし（操作ログをファイル保存する可能性あり）
-   **ユーザー規模:**
    -   ユーザー数: 1人 (管理者のみ)
    -   同時接続数: 1人
-   **セキュリティ:**
    -   NginxレベルでのIPアドレス制限（必須）
    -   アプリケーションレベルでのパスワード認証（必須、2段階認証も検討）

---

#### 3.8 `discord-bot`

-   **サブドメイン:** なし (Webサーバーではない)
-   **フォルダ:** `srv/discord-bot/`
-   **概要:** Discordサーバーで動作する多機能Bot。
-   **構成:** **独立プロセス**
-   **技術:** Node.js, `discord.js`
-   **機能:**
    -   `discord-chat` (l1) との連携
    -   画像とテキストのDB保存
    -   その他、Discordサーバー向けの各種機能
-   **データベース:** PostgreSQL
    -   **DB名:** `discordbot_db`
    -   **ユーザー名:** `discordbot_user`
    -   **保存データ:** 連携に必要なデータ、投稿された画像パス/テキスト
-   **ユーザー規模:**
    -   サーバー参加者: 約100人
-   **NOTE:**
    -   PM2でプロセスをデーモン化して管理する。
    -   `discord-chat`との連携には、RedisのPub/Subを利用するのが最も疎結合でスケールしやすい。