はい、承知いたしました。
最終的に完成したMermaid図の構成に合わせて、サーバー構成のテキストドキュメントを全面的に更新します。

---

### 1. Proxmox VE ホスト構成

-   **OS:** Proxmox Virtual Environment
-   **CPU:** Ryzen 7 5825U (8コア/16スレッド)
-   **RAM:** 32GB
-   **SSD:** 1TB
-   **ストレージ:** **ZFS**
    -   SSD上にZFSプールを構成し、スナップショット機能による効率的なバックアップとデータ保護を実現。
    -   重要なデータ（DB、証明書、監視データ等）は、このストレージ層で一元管理する。

### 2. ネットワークアーキテクチャ

#### 2.1. ネットワーク分離

本サーバーは、セキュリティを強化するため、2つの仮想ネットワークブリッジを構成します。

-   **`vmbr0` (外部公開用ネットワーク):**
    -   物理LANに接続され、外部からのアクセスを受け付けます。
    -   このネットワークには、唯一の窓口となる**リバースプロキシ (Traefik) コンテナのみ**を配置します。
-   **`vmbr1` (内部用ネットワーク):**
    -   外部から直接アクセスできない隔離されたネットワークです。
    -   すべてのアプリケーションコンテナとデータベース等のコアサービスは、このネットワークに配置します。

#### 2.2. ドメイン・DDNS

-   **メインホスト名:** `shiratama.mydns.jp`
-   **専用ホスト名:** `natyu-seitokai.mydns.jp`

#### 2.3. 外部アクセスフローとセキュリティ

外部からのWebアクセス (TCP:80, 443) は、以下の多層防御を経て各サービスに到達します。

1.  **ルーター:** 外部からのポート80/443への全アクセスを、Proxmox VEホストへ転送します。
2.  **PVEホストファイアウォール (UFW):** Proxmoxホスト自体を保護します。Webアクセス以外の不要なポート（SSH, 管理画面など）へのアクセスを制限します。
3.  **リバースプロキシ (LXC 100: Traefik):** `vmbr0`上で稼働し、すべてのWebアクセスを受け止めます。
    -   **SSL終端:** SSL証明書の管理とHTTPS通信の暗号化・復号を一手に担います。
    -   **Fail2Ban連携:** アクセスログを監視し、不正アクセスを試みるIPアドレスを自動的にブロックします。
    -   **ルーティング:** リクエストのホスト名とURLパスを判別し、安全な内部ネットワーク (`vmbr1`) 上の適切なコンテナへリクエストを転送します。

#### 2.4. ルーティング戦略 (Traefik)

-   **ホスト名ベース:** `natyu-seitokai.mydns.jp` へのアクセスは、`nachu-seitokai`用LXCコンテナへ転送。
-   **パスベース:** `shiratama.mydns.jp` へのアクセスは、URLパスに応じて各サービスへ転送。
    -   `shiratama.mydns.jp/` → `portfolio`用LXC
    -   `shiratama.mydns.jp/proxtube/` → `proxy-youtube`用LXC
    -   (その他サービスも同様)

### 3. 自動化と監視

#### 3.1. 自動化タスク (LXC 110: Automation)

インフラ関連の自動化タスクは、専用のコンテナに集約して管理します。

-   **DDNS自動更新:** `cron`とシェルスクリプトを利用し、定期的にグローバルIPアドレスをMyDNS.jpへ通知します。
-   **バックアップ:** ZFSスナップショットの作成や、重要な設定ファイルのバックアップを定期的に実行します。

#### 3.2. サービス監視 (LXC 107: admin)

-   **Prometheus / Grafana** を導入し、Proxmoxホストおよび各ゲストのリソース使用率、ネットワークトラフィック、サービスの状態などを継続的に監視・可視化します。
-   収集した監視データは、コンテナ外の永続ストレージに保存されます。

### 4. ゲスト構成 (LXC & KVM)

| ID (例)      | 名前                  | 種別  | 役割・搭載サービス                           | 備考                                 |
| :---------- | :------------------ | :-- | :---------------------------------- | :--------------------------------- |
| **LXC 100** | **reverse**         | LXC | **Traefik (リバースプロキシ), Fail2Ban**    | **vmbr0**に配置。唯一の外部窓口。証明書は永続ストレージへ。 |
| **LXC 101** | **portfolio**       | LXC | `portfolio` (Next.js Static)        |                                    |
| **LXC 102** | **nachu-seitokai**  | LXC | `nachu-seitokai` (Next.js)          |                                    |
| **LXC 103** | **proxy-youtube**   | LXC | `proxy-youtube` (Next.js, Express)  |                                    |
| **LXC 104** | **3d-fps**          | LXC | `3d-fps` のWebフロント/サーバー部             |                                    |
| **LXC 105** | **discord-chat**    | LXC | `discord-chat` (Next.js, Express)   |                                    |
| **LXC 106** | **cpu-ranking**     | LXC | `cpu-ranking` (Next.js)             |                                    |
| **LXC 107** | **admin**           | LXC | 管理サイト, **Prometheus, Grafana**      | 監視データは永続ストレージへ。                    |
| **LXC 108** | **discord-bot**     | LXC | `discord-bot` (Node.js, Discord.js) |                                    |
| **LXC 109** | **redis-cache**     | LXC | **Redis** (キャッシュ / PubSub)          | 軽量なLXCで効率的に運用。                     |
| **LXC 110** | **Automation**      | LXC | **DDNS更新, バックアップスクリプト**             | Cronによるインフラ自動化タスクを実行。              |
| **KVM 200** | **cpp-game-server** | KVM | `3d-fps` のC++ゲームサーバー                |                                    |
| **KVM 201** | **database**        | KVM | **PostgreSQL**                      | データは永続ストレージへ。                      |

### 5. 主要な技術スタックとツール

-   **仮想化基盤:** Proxmox VE, KVM, LXC
-   **ストレージ:** ZFS (スナップショットによるデータ保護)
-   **ネットワーキング & セキュリティ:** Traefik (リバースプロキシ), Fail2Ban (不正アクセス遮断), UFW (ホストファイアウォール)
-   **データベース & キャッシュ:** PostgreSQL, Redis
-   **監視 & 自動化:** Prometheus, Grafana, Cron
-   **アプリケーション管理:** PM2 (Node.jsプロセス管理)