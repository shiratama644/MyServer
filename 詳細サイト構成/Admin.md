-   **URL:** `shiratama.mydns.jp/admin/`
-   **コンテナ:** `LXC 107`
-   **コンセプト:** Proxmox VE上で稼働する全サービスを、単一のWebインターフェースから統合的に監視・管理するための管理者専用ダッシュボード。SSHによるコマンドライン操作を極力不要にし、直感的かつ迅速なサーバー運用を実現することを目的とする。
-   **構成:** **一体型 (Next.js + Express.js + Socket.IO)**

---

### 1. ユーザー権限と認証

-   **認証方式:** **Googleアカウント + 固定パスワードによる2段階認証。**
    1.  **第1段階 (Google認証):** `NextAuth.js`ライブラリのGoogle Providerを利用。環境変数に設定された特定のGoogleアカウント以外はアクセスを拒否する。
    2.  **第2段階 (パスワード認証):** Google認証成功後、パスワード入力画面に遷移。環境変数に設定されたサイト専用の固定パスワードを入力する。
-   **権限レベル (Role):**
    1.  **ADMIN (管理者):** サイトの全機能にアクセス可能。
    2.  **GUEST (未認証):** ログインページのみ表示。
-   **認証情報の設定フロー:**
    -   `.env`ファイルに、許可するGoogleアカウントのメールアドレスと、サイト専用パスワードを設定する。
        -   `ADMIN_GOOGLE_EMAILS=2011hikaru.a@gmail.com`
        -   `ADMIN_SITE_PASSWORD=")I4)@PE0AW,ZHHp^{<^4"`
    -   アプリケーションは起動時にこの設定を読み込み、認証ロジックで使用する。

---

### 2. UI/UX

-   **デザイン:**
    -   **テーマ:** ダークテーマを基調とした、視認性の高いデザイン。サーバー情報を扱うため、グラフやステータス表示には明確な配色（緑: 正常, 黄: 注意, 赤: 異常）を用いる。
    -   **レスポンシブ:** PCでの操作を主眼に置くが、スマートフォンからも緊急時の基本的な状態確認や再起動操作ができるように最適化する。
-   **ページ構成:**
    -   **ナビゲーション:** PCでは画面左側に、各機能へのリンクを持つ固定サイドバーを配置。
    -   **ログインページ (`/admin/g-login`):** 1段階目の認証 **(google)** となるページ。
    -   **2段階ログインページ (`/admin/two-login`):** 2段階目の認証 **(password)** となるページ。
    -   **ダッシュボード (`/admin/dashboard`):** ログイン後の初期表示ページ。サーバー全体の健全性をひと目で確認できる。
    -   **ゲスト管理 (`/admin/guests`):** LXC/KVMの一覧表示と基本操作を行う。
    -   **アプリケーション管理 (`/admin/apps`):** 最初に操作したいLXC/KVMを選択し、その中のPM2で管理されるNode.jsアプリを選択して操作を行う。
    -   **ログビューア (`/admin/logs`):** 各種ログファイルを確認する。
    -   **リモートターミナル (`/admin/terminal`):** サーバーのシェルを直接操作する。
    -    **セキュリティ (`/admin/security`):** サーバーへの不正アクセス試行や、システムの脆弱性を監視し、セキュリティ状態を直感的に把握する。

---

### 3. 主要機能

#### 3.1 ログイン
-   **UI_1:** 
-   UI_
-   **機能:**
    -   **

#### 3.2 ダッシュボード

-   **UI:** 複数の情報カードがグリッド状に配置されたレイアウト。
-   **機能:**
    -   **ホストリソース監視:**
        -   CPU使用率、メモリ使用率、ネットワークトラフィックをリアルタイムで更新される折れ線グラフで表示。
        -   SSDストレージ使用率をゲージ形式で表示。
    -   **ゲストサマリー:**
        -   全ゲストの総数と、現在「起動中」のゲスト数を表示。

#### 3.3 ゲスト管理

-   **UI:** テーブル（表）形式で全ゲストの一覧を表示。
-   **表示項目:** ID, 名前, 種別(LXC/KVM), ステータス(起動中/停止中), IPアドレス, CPU使用率, メモリ使用率。
-   **機能:**
    -   **状態表示:** 「起動中」は緑色、「停止中」は灰色のラベルで表示し、視覚的に分かりやすくする。
    -   **操作:** 各行の右端にアクションボタン（「起動」「停止」「再起動」）を配置。クリックすると確認ダイアログが表示され、承認するとサーバーサイドにリクエストが送信される。

#### 3.4 アプリケーション管理

-   **UI:** ページ上部に操作対象のLXCコンテナを選択するドロップダウンリストを配置。その下に、選択されたコンテナ内のPM2プロセスがテーブル形式で表示される。
-   **表示項目:** アプリ名, ID, ステータス, CPU使用率, メモリ使用量, uptime。
-   **機能:**
    -   **コンテナ選択:** ドロップダウンでLXCコンテナを選択すると、そのコンテナ内のPM2プロセス情報が非同期で読み込まれ、一覧が更新される。
    -   **プロセス操作:** 各プロセス行に「再起動」「停止」ボタンを配置。
    -   **ログ表示:** 「ログ表示」ボタンをクリックすると、画面下部またはモーダルウィンドウが開き、該当プロセスのリアルタイムログ（標準出力/エラー出力）が表示される。

#### 3.5 ログビューア

-   **UI:** ページ上部に閲覧したいログファイルを選択するドロップダウンリストと、「リアルタイム追跡」のON/OFFを切り替えるスイッチを配置。ログ内容は大きなテキストエリアに表示される。
-   **対象ログ:**
    -   DDNS自動更新ログ (`mydns_update.log`)
    -   Nginxアクセスログ (`access.log`)
    -   Nginxエラーログ (`error.log`)
-   **機能:**
    -   **ログ選択:** ドロップダウンでログを選択すると、サーバーから最新のログ内容（例: 末尾100行）が読み込まれる。
    -   **リアルタイム追跡:** スイッチをONにすると、WebSocketを通じてサーバーからのログ追記情報がリアルタイムにフロントエンドに送られ、テキストエリアの末尾に自動で追加されていく。

#### 3.6 リモートターミナル

-   **UI:** ページ上部に接続先のホスト/コンテナを選択するドロップダウンリストを配置。その下に、黒い背景のターミナル画面が表示される。
-   **機能:**
    -   **接続先選択:** ドロップダウンで接続先（Proxmoxホスト, LXC 107など）を選択すると、サーバーサイドで対応するターミナルプロセスが起動し、WebSocketで接続される。
    -   **ターミナル操作:** ユーザーが入力したキーボード操作はWebSocket経由でサーバーのターミナルプロセスに送られ、その実行結果（画面出力）が同じくWebSocket経由でフロントエンドに返され、画面に描画される。

#### 3.7 セキュリティ

-   **UI:** ページは「**アクセスログ**」「**ファイアウォール**」「**パッケージ更新**」の3つのタブで構成される。

##### **3.7.1 アクセスログ (Audit Log) タブ**

-   **UI:** ログイン試行の履歴をテーブル形式で一覧表示する。
-   **表示項目:**
    -   **日時:** イベントが発生した日時。
    -   **認証タイプ:** `Google Auth`, `Password Auth` など。
    -   **結果:** `成功` (緑), `失敗` (赤) のラベル表示。
    -   **ユーザー情報/メールアドレス:** Google認証の場合に表示。
    -   **IPアドレス:** リクエスト元のグローバルIPアドレス。
    -   **国:** IPアドレスから推定される国名と国旗アイコン。
-   **機能:**
    -   **ログイン失敗のハイライト:** 結果が「失敗」の行は、背景色を薄い赤にすることで注意を促す。
    -   **IPアドレス検索:** IPアドレスをクリックすると、外部のIPアドレス情報サイト（例: `abuseipdb.com`）が新しいタブで開く。

##### **3.7.2 ファイアウォール (Firewall) タブ**

-   **UI:** 現在のファイアウォール（`UFW: Uncomplicated Firewall`を想定）の状態と、ブロックされているIPアドレスの一覧を表示する。
-   **表示内容:**
    -   **UFWステータス:** 「有効 (Active)」または「無効 (Inactive)」を大きく表示。
    -   **ブロックリスト:** `ufw deny from <IPアドレス>` によってブロックされているIPアドレスの一覧をテーブルで表示。
        -   **表示項目:** ブロック中のIPアドレス, ブロックした日時（手動追加の場合）, メモ
-   **機能:**
    -   **IPアドレスのブロック:**
        -   入力欄にブロックしたいIPアドレスを入力し、「ブロック追加」ボタンを押すと、サーバー側で`ufw deny from <IPアドレス>`コマンドが実行される。
        -   アクセスログタブの「失敗」ログの横に「このIPをブロック」ボタンを設置し、ワンクリックでブロックリストに追加できるようにする。
    -   **ブロック解除:** ブロックリストの各IPアドレスの横にある「解除」ボタンを押すと、対応する`ufw delete deny from <IPアドレス>`コマンドが実行される。

##### **3.7.3 パッケージ更新 (Updates) タブ**

-   **UI:** Proxmoxホストおよび各LXCコンテナの、アップデート可能なパッケージ（`apt`）の情報を表示する。
-   **表示内容:**
    -   ページ上部に、情報を確認したい対象（Proxmoxホスト, LXC 101, LXC 102...）を選択するドロップダウンリストを配置。
    -   対象を選択すると、そのシステムで`apt list --upgradable`を実行した結果が表示される。
    -   **サマリー:** 「**X個**のパッケージが更新可能です。うち、**Y個**はセキュリティアップデートです。」といった要約情報をカードで表示。
    -   **詳細リスト:** 更新可能なパッケージの一覧をテーブルで表示。
        -   **表示項目:** パッケージ名, 現在のバージョン, 新しいバージョン, 種別（セキュリティ/通常）
-   **機能:**
    -   **情報更新:** 「最新情報を取得」ボタンを押すと、サーバー側で対象システムの`apt update`が実行され、最新のパッケージ情報に更新される。
    -   **一括アップデートボタン (注意喚起付き):**
        -   「すべてのパッケージをアップグレード」ボタンを設置。
        -   クリックすると、「**本番環境での一括アップデートは予期せぬ不具合を引き起こす可能性があります。重要な更新は手動での実行を推奨します。続行しますか？**」という警告付きの確認ダイアログが表示される。
        -   承認すると、サーバー側で`apt upgrade -y`が実行され、その実行ログがリアルタイムで画面に表示される。

---

### 4. サーバーサイド処理

このサイトはデータベースを持たず、サーバーサイドの主な役割は**「フロントエンドからの要求に応じて、サーバー（Proxmoxホストやゲスト）の情報を取得・操作し、その結果をリアルタイムに返すこと」**です。

#### **認証 (Auth)**

-   **概要:** `NextAuth.js`とカスタムのExpressミドルウェアを組み合わせて2段階認証を実現します。
-   **処理フロー:**
    1.  Next.jsのサーバーサイドで`NextAuth.js`がGoogle認証を処理します。環境変数`ADMIN_GOOGLE_EMAILS`に含まれないユーザーは弾かれます。
    2.  Google認証済みのセッションを持つユーザーがパスワード入力ページにアクセスすると、入力されたパスワードがAPIリクエストでサーバーに送信されます。
    3.  サーバーは受け取ったパスワードと環境変数`ADMIN_SITE_PASSWORD`を比較検証し、一致すればパスワード認証済みのセッショントークンを発行します。
    4.  以降、すべてのAPIリクエストでこのトークンの有効性を検証します。

#### **リアルタイム通信 (WebSocket)**

-   **概要:** サーバーの状態監視やリアルタイムログなど、動的な情報のやり取りには`Socket.IO`ライブラリを使用します。
-   **通信チャンネル（イベント）:**
    -   `get:host_stats`: フロントエンドが接続した際、サーバーのCPU/メモリ等の統計情報を定期的に（例: 1秒ごとに）送信します。
    -   `stream:logs`: ログビューアで「リアルタイム追跡」がONの時、指定されたログファイルの追記内容をストリーミング送信します。
    -   `terminal:io`: リモートターミナルでのキーボード入力と画面出力を双方向でやり取りします。

#### **サーバー・ゲスト操作**

-   **概要:** フロントエンドからの操作リクエスト（例: コンテナの再起動）を受け取り、サーバー上でOSコマンドを実行します。
-   **技術:**
    -   Node.jsの`child_process`モジュール（`exec`や`spawn`）を利用して、Proxmox VEが提供するコマンドラインツール（`pct`, `qm`）や、`pm2`コマンドを実行します。
-   **処理例 (ゲスト管理):**
    -   **一覧取得:** `pct list` や `qm list` コマンドを実行し、その標準出力をパース（解析）してJSON形式に整形し、フロントエンドに返します。
    -   **操作実行:** フロントエンドから `POST /api/guests/101/reboot` のようなリクエストを受け取ると、サーバーサイドで`pct reboot 101`コマンドを実行します。コマンドの実行成否をフロントエンドに返します。
-   **セキュリティ:**
    -   フロントエンドから受け取ったパラメータ（コンテナIDなど）は、OSコマンドインジェクション攻撃を防ぐため、必ずバリデーション（検証）を行ってからコマンドに渡します。

#### **リモートターミナル (node-pty)**

-   **概要:** ブラウザ上のターミナルとサーバーの実際のシェルを繋ぐために`node-pty`ライブラリを使用します。
-   **処理フロー:**
    1.  フロントエンドから接続要求があると、サーバーサイドで`node-pty`を使ってシェルプロセス（例: `/bin/bash`）を起動します。
    2.  このプロセスとクライアント間のWebSocket接続を確立します。
    3.  クライアントからのデータ（キー入力）をシェルの標準入力に書き込み、シェルの標準出力からのデータをクライアントに送信します。これを双方向で行うことで、擬似的なターミナル環境を実現します。

#### **セキュリティ関連処理**

-   **アクセスログの記録:**
    -   **概要:** 認証APIへのすべてのリクエスト（成功・失敗問わず）を、専用のログファイル（例: `/var/log/admin_auth.log`）にJSON形式で記録する。
    -   **記録情報:** 日時, 認証タイプ, 結果, メールアドレス, IPアドレス。
    -   **実装:** フロントエンドからリクエストがあると、認証処理を行うミドルウェアがログを書き出す。IPアドレスから国を推定するには、`geoip-lite`などのライブラリを利用する。

-   **ファイアウォール操作:**
    -   **概要:** フロントエンドからの要求に応じて、`ufw`コマンドを実行する。
    -   **実装:** `child_process`モジュールを利用。`ufw status`, `ufw deny`, `ufw delete`などのコマンドを実行し、その結果を返す。`sudo`権限が必要なため、`visudo`でNode.jsの実行ユーザーにパスワードなしで`ufw`コマンドの実行を許可する設定が別途必要になる。

-   **パッケージ更新情報の取得:**
    -   **概要:** 指定されたホスト/コンテナに対して、`apt`関連のコマンドを実行し、その出力を解析する。
    -   **実装:**
        -   Proxmoxホストに対しては、直接`apt update`や`apt list --upgradable`を実行。
        -   LXCコンテナに対しては、`pct exec <コンテナID> -- apt update` のように、`pct exec`コマンド経由でコンテナ内部のコマンドを実行する。
        -   コマンドの標準出力を正規表現などでパースし、パッケージ名やバージョン情報を抽出してJSON形式でフロントエンドに返す。

---

### 5. データベース (PostgreSQL)

-   **DB名:** `admin_db`
-   **ユーザー名:** `admin_user`
-   **スキーマ設計:**

##### **`audit_logs` テーブル**

-   **概要**:
    管理者サイトへのすべてのログイン試行（成功・失敗問わず）を記録するためのテーブルです。「セキュリティ」ページの「アクセスログ」タブのデータソースとなります。

-   **カラム定義**:
    -   `id`
        -   **データ型**: `SERIAL`
        -   **制約**: `PRIMARY KEY`
        -   **説明**: ログの一意な連番ID。
    -   `timestamp`
        -   **データ型**: `TIMESTAMP WITH TIME ZONE`
        -   **制約**: `NOT NULL`, `DEFAULT CURRENT_TIMESTAMP`
        -   **説明**: イベントが発生した日時。
    -   `auth_type`
        -   **データ型**: `VARCHAR(20)`
        -   **制約**: `NOT NULL`
        -   **説明**: 試行された認証の種類（例: `'GOOGLE'`, `'PASSWORD'`）。
    -   `outcome`
        -   **データ型**: `VARCHAR(10)`
        -   **制約**: `NOT NULL`
        -   **説明**: 認証試行の結果（`'SUCCESS'`, `'FAILURE'`）。
    -   `email`
        -   **データ型**: `VARCHAR(255)`
        -   **制約**: `NULL`許容
        -   **説明**: Google認証で試行されたメールアドレス。
    -   `ip_address`
        -   **データ型**: `VARCHAR(45)`
        -   **制約**: `NOT NULL`
        -   **説明**: リクエスト元のIPアドレス。IPv6にも対応。
    -   `country_code`
        -   **データ型**: `VARCHAR(2)`
        -   **制約**: `NULL`許容
        -   **説明**: IPアドレスから推定された国を示す2文字のコード（例: `JP`, `US`）。
    -   `user_agent`
        -   **データ型**: `TEXT`
        -   **制約**: `NULL`許容
        -   **説明**: リクエスト元のブラウザやクライアント情報。

-   **インデックス**:
    -   `timestamp`: 時系列での検索やソートを高速化します。
    -   `ip_address`: 特定のIPアドレスからのアクセス履歴を高速に検索するために設定します。

##### **`firewall_blocks` テーブル**

-   **概要**:
    UFW (Uncomplicated Firewall) によってブロックされたIPアドレスの情報を永続的に管理します。「セキュリティ」ページの「ファイアウォール」タブで表示・操作するリストの元データとなります。`ufw status`コマンドの出力を都度パースするよりも、信頼性が高く、追加情報（理由など）も管理できます。

-   **カラム定義**:
    -   `id`
        -   **データ型**: `SERIAL`
        -   **制約**: `PRIMARY KEY`
        -   **説明**: ブロック情報の一意な連番ID。
    -   `ip_address`
        -   **データ型**: `VARCHAR(45)`
        -   **制約**: `NOT NULL`, `UNIQUE`
        -   **説明**: ブロック対象のIPアドレス。重複してブロックしないように`UNIQUE`制約を設けます。
    -   `is_active`
        -   **データ型**: `BOOLEAN`
        -   **制約**: `NOT NULL`, `DEFAULT true`
        -   **説明**: このブロックルールが現在有効かどうかを示すフラグ。`true`なら有効（ブロック中）、`false`なら無効（ブロック解除済み）。レコードを削除せずに履歴として残せます。
    -   `memo`
        -   **データ型**: `TEXT`
        -   **制約**: `NULL`許容
        -   **説明**: なぜこのIPをブロックしたかの理由を記録するメモ欄（例: `ログイン試行に5回失敗`, `管理者による手動ブロック`）。
    -   `blocked_at`
        -   **データ型**: `TIMESTAMP WITH TIME ZONE`
        -   **制約**: `NOT NULL`, `DEFAULT CURRENT_TIMESTAMP`
        -   **説明**: IPアドレスがブロックされた日時。
    -   `unblocked_at`
        -   **データ型**: `TIMESTAMP WITH TIME ZONE`
        -   **制約**: `NULL`許容
        -   **説明**: ブロックが解除された日時。`is_active`が`false`になった時に記録します。

-   **インデックス**:
    -   `ip_address`: `UNIQUE`制約により自動で作成されます。IPアドレスによる検索を高速化します。
    -   `is_active`: 現在ブロック中のIPアドレス（`WHERE is_active = true`）を高速に一覧表示するために設定します。